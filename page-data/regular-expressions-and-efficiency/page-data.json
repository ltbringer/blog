{"componentChunkName":"component---src-templates-post-js","path":"/regular-expressions-and-efficiency","result":{"data":{"markdownRemark":{"html":"<p>To start our study, we will use this <a href=\"https://github.com/clinc/oos-eval/blob/master/data/data_full.json\">dataset</a> from <a href=\"https://github.com/clinc/oos-eval\">this repository</a>.\nAn introductory analysis shows:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># CLINIC 150</span>\nIn <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">import</span> json                                                                               \n\n\nIn <span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"voice_commands/data_full.json\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"r\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span> \n   <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span>     data <span class=\"token operator\">=</span> json<span class=\"token punctuation\">.</span>load<span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span> \n   <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span>                                                                                           \n\nIn <span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>                                                                                 \nOut<span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> <span class=\"token number\">6</span>\n\nIn <span class=\"token punctuation\">[</span><span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">import</span> pydash <span class=\"token keyword\">as</span> py_                                                                      \nIn <span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> flat_items <span class=\"token operator\">=</span> py_<span class=\"token punctuation\">.</span>flatten<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>                                                   \n\nIn <span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>flat_items<span class=\"token punctuation\">)</span>                                                                           \nOut<span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> <span class=\"token number\">23700</span>\n\nIn <span class=\"token punctuation\">[</span><span class=\"token number\">7</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> flat_items<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>                                                                             \nOut<span class=\"token punctuation\">[</span><span class=\"token number\">7</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'set a warning for when my bank account starts running low'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'oos'</span><span class=\"token punctuation\">]</span>\n\nIn <span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> data<span class=\"token punctuation\">.</span>keys<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>                                                                              \nOut<span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> dict_keys<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'oos_val'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'val'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'train'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'oos_test'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'test'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'oos_train'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\nIn <span class=\"token punctuation\">[</span><span class=\"token number\">9</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> data<span class=\"token punctuation\">[</span><span class=\"token string\">\"oos_val\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>                                                                       \nOut<span class=\"token punctuation\">[</span><span class=\"token number\">9</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'set a warning for when my bank account starts running low'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'oos'</span><span class=\"token punctuation\">]</span>\n\nIn <span class=\"token punctuation\">[</span><span class=\"token number\">10</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> data<span class=\"token punctuation\">[</span><span class=\"token string\">\"val\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>                                                                           \nOut<span class=\"token punctuation\">[</span><span class=\"token number\">10</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'in spanish, meet me tomorrow is said how'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'translate'</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>Now, let's look at the training data a little bit to see what we have.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># CLINIC150</span>\nIn <span class=\"token punctuation\">[</span><span class=\"token number\">16</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">import</span> random\n\nIn <span class=\"token punctuation\">[</span><span class=\"token number\">17</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">import</span> copy\n\nIn <span class=\"token punctuation\">[</span><span class=\"token number\">18</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> training_data <span class=\"token operator\">=</span> copy<span class=\"token punctuation\">.</span>deepcopy<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">[</span><span class=\"token string\">\"train\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># To avoid mutating the reference.</span>\n\nIn <span class=\"token punctuation\">[</span><span class=\"token number\">22</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> sentence<span class=\"token punctuation\">,</span> tags <span class=\"token operator\">=</span> <span class=\"token builtin\">zip</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>training_data<span class=\"token punctuation\">)</span>\n\nIn <span class=\"token punctuation\">[</span><span class=\"token number\">23</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> labels <span class=\"token operator\">=</span> <span class=\"token builtin\">set</span><span class=\"token punctuation\">(</span>labels<span class=\"token punctuation\">)</span>\n\nIn <span class=\"token punctuation\">[</span><span class=\"token number\">24</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">set</span><span class=\"token punctuation\">(</span>labels<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>training_data<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># Coincidence?</span>\nOut<span class=\"token punctuation\">[</span><span class=\"token number\">24</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> <span class=\"token number\">150</span><span class=\"token punctuation\">,</span> <span class=\"token number\">15000</span></code></pre></div>\n<p>This data-set seems to have a lot of diversity and the labels hint at conflicting vocabularies, this should be fun.\nWe have 7 types of change intents:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># change intents</span>\n <span class=\"token string\">'change_accent'</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'change_ai_name'</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'change_language'</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'change_speed'</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'change_user_name'</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'change_volume'</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>and 3 types of intents that have credit as keyword:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># credit labels</span>\n <span class=\"token string\">'credit_limit'</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'credit_limit_change'</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'credit_score'</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>These are just preliminary, eye-balled labels. There could be more than this but for our study we need either of them to have around 5-6k data points. Let's check that out.</p>\n<p>Turns out the data-set is eerily balanced all labels have 100 data points each. So we'll work with the 900 that we get from <code class=\"language-text\">%change%</code> intents.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token punctuation\">{</span><span class=\"token string\">'change_accent'</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'change_ai_name'</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'change_language'</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'change_speed'</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'change_user_name'</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'change_volume'</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'credit_limit_change'</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'exchange_rate'</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'insurance_change'</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'oil_change_how'</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'oil_change_when'</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'pin_change'</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'tire_change'</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>A random view of the sentences before we can proceed with the next few steps:</p>\n<ol>\n<li>i wanna <code class=\"language-text\">change</code> your name to audrey</li>\n<li>please respond to me in spanish</li>\n<li>when do you think i should <code class=\"language-text\">change</code> my oil</li>\n<li>can you swap to male voice</li>\n<li>how long is an oil <code class=\"language-text\">change</code> good for</li>\n<li>when does my oil need some changing</li>\n<li>hey, speak slowly</li>\n<li>i want you to speak to me faster</li>\n<li>can you use a different accent</li>\n<li>could you slow down your speech</li>\n<li>what oil do i need and how is it <code class=\"language-text\">change</code>d</li>\n<li>i want to use spanish as my language</li>\n<li>could i please <code class=\"language-text\">change</code> your name to alicia</li>\n<li>please <code class=\"language-text\">change</code> my name</li>\n<li>i need for you to <code class=\"language-text\">change</code> your accent to the male british one</li>\n<li>give me instructions on how to <code class=\"language-text\">change</code> my oil</li>\n<li>i gotta <code class=\"language-text\">change</code> your name to remy</li>\n<li>hey, stop talking like you're a stretch taped</li>\n<li>can you find instructions on how to <code class=\"language-text\">change</code> oil in a car</li>\n<li>i need to <code class=\"language-text\">change</code> your name to ben</li>\n</ol>\n<p>11/20 sentences have the keyword, Seems like a good feature. Let's write a couple of regular expressions to see how well it goes.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">patterns <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n   <span class=\"token string\">r\"change.*name\"</span><span class=\"token punctuation\">,</span>  \n   <span class=\"token string\">r\"change.*oil\"</span><span class=\"token punctuation\">,</span>  \n   <span class=\"token string\">r\"swap.*accent\"</span><span class=\"token punctuation\">,</span>  \n   <span class=\"token string\">r\"need.*change\"</span><span class=\"token punctuation\">,</span> \n   <span class=\"token string\">r\"please.*change\"</span><span class=\"token punctuation\">,</span> \n   <span class=\"token string\">r\"i need to.*change\"</span><span class=\"token punctuation\">,</span> \n   <span class=\"token string\">r\"limit.*change\"</span><span class=\"token punctuation\">,</span> \n   <span class=\"token string\">r\"change.*pin\"</span><span class=\"token punctuation\">,</span> \n   <span class=\"token string\">r\"change.*tires?\"</span><span class=\"token punctuation\">,</span> \n   <span class=\"token string\">r\"change.*credit limit\"</span><span class=\"token punctuation\">,</span> \n   <span class=\"token string\">r\"language.*change\"</span><span class=\"token punctuation\">,</span> \n   <span class=\"token string\">r\"change language\"</span><span class=\"token punctuation\">,</span> \n   <span class=\"token string\">r\"pin.*change\"</span><span class=\"token punctuation\">,</span> \n   <span class=\"token string\">r\"speed.*change\"</span><span class=\"token punctuation\">,</span> \n   <span class=\"token string\">r\"change.*accent\"</span><span class=\"token punctuation\">,</span> \n   <span class=\"token string\">r\"credit.*change\"</span><span class=\"token punctuation\">,</span> \n   <span class=\"token string\">r\"insurance.*change\"</span><span class=\"token punctuation\">,</span> \n   <span class=\"token string\">r\"oil.*change\"</span><span class=\"token punctuation\">,</span> \n   <span class=\"token string\">r\"change.*speed\"</span><span class=\"token punctuation\">,</span> \n   <span class=\"token string\">r\"how.*change\"</span><span class=\"token punctuation\">,</span> \n   <span class=\"token string\">r\"when.*change\"</span><span class=\"token punctuation\">,</span> \n   <span class=\"token string\">r\"why.*change\"</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n<p>We have 21 patterns just for change, let's scan our 15k strong dataset to see how bad are these features for picking <code class=\"language-text\">change_*</code> intents.\nSince we didn't target all patterns possible, it's okay to miss a lot out of 900, but it would be bad to match a lot with other intents.\nLet's see how that goes.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">match_change</span><span class=\"token punctuation\">(</span>items<span class=\"token punctuation\">,</span> patterns<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> \n    matches <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> \n    scores <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> \n    <span class=\"token keyword\">for</span> item <span class=\"token keyword\">in</span> items<span class=\"token punctuation\">:</span> \n        <span class=\"token keyword\">for</span> pattern <span class=\"token keyword\">in</span> patterns<span class=\"token punctuation\">:</span> \n            sentence <span class=\"token operator\">=</span> item<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> \n            match <span class=\"token operator\">=</span> re<span class=\"token punctuation\">.</span>search<span class=\"token punctuation\">(</span>pattern<span class=\"token punctuation\">,</span> sentence<span class=\"token punctuation\">)</span> \n            <span class=\"token keyword\">if</span> match<span class=\"token punctuation\">:</span> \n                matches<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span> \n                scores<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>match<span class=\"token punctuation\">.</span>end<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> match<span class=\"token punctuation\">.</span>start<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> \n    <span class=\"token keyword\">return</span> matches<span class=\"token punctuation\">,</span> scores</code></pre></div>\n<p>We have an <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(n^{2})</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.064108em;vertical-align:-0.25em;\"></span><span class=\"mord mathdefault\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathdefault\">n</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span> here, we could skip at the first match to get to <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mi>n</mi><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(n\\log{n})</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathdefault\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord mathdefault\">n</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mop\">lo<span style=\"margin-right:0.01389em;\">g</span></span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord\"><span class=\"mord mathdefault\">n</span></span><span class=\"mclose\">)</span></span></span></span>, but we would like to use the span of the pattern to judge if we should go forward.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># - Profiling code</span>\nIn <span class=\"token punctuation\">[</span><span class=\"token number\">17</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> <span class=\"token operator\">%</span>time matches<span class=\"token punctuation\">,</span> scores <span class=\"token operator\">=</span> match_change<span class=\"token punctuation\">(</span>training_data<span class=\"token punctuation\">,</span> patterns<span class=\"token punctuation\">)</span>                            \nCPU times<span class=\"token punctuation\">:</span> user <span class=\"token number\">200</span> ms<span class=\"token punctuation\">,</span> sys<span class=\"token punctuation\">:</span> <span class=\"token number\">0</span> ns<span class=\"token punctuation\">,</span> total<span class=\"token punctuation\">:</span> <span class=\"token number\">200</span> ms\nWall time<span class=\"token punctuation\">:</span> <span class=\"token number\">200</span> ms</code></pre></div>\n<p>That is very slow. <strong>200ms</strong> for just 21 patterns? we haven't even covered 100s of intents and this is just one pre-processing step. We will probably be building more features\nlike <em>pos-tags</em>, <em>tfidf vectors</em> maybe we will use <em>word2vec</em>? or use the scores we just obtained to tune out the false positives and then the model inference. Production systems\nmust cater to patience range of human beings to qualify as good products.</p>\n<p>Sure this also depends on the type of work. A batch-process that delivers results on e-mail after a while may be allowed to take that much time.\nHere we are looking at the data of a smart-home device. Devices that should answer within <strong>2-3 seconds</strong>, already lose some time to accommodate for user speech (silence-detection),\nusually getting nothing more than a second's leeway for replying back which has more things to compute than just the <code class=\"language-text\">intent</code>. It has to probably call an API, embed words into a\nresponse template and then convert that text to speech. All under <strong>1s</strong>. Can we afford to have a single step of pre-processing take <strong>200ms</strong>?</p>\n<h2 id=\"hammers-and-pick-axes\" style=\"position:relative;\"><a href=\"#hammers-and-pick-axes\" aria-label=\"hammers and pick axes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Hammers and Pick-axes</h2>\n<p>Let's try to identify what is making things slow. We'll use <code class=\"language-text\">snakeviz</code> and <code class=\"language-text\">cProfile</code> for that.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">pip install snakeviz</code></pre></div>\n<p>and inspect around the function to see what can we do about it.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">In <span class=\"token punctuation\">[</span><span class=\"token number\">19</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">import</span> cProfile\n\nIn <span class=\"token punctuation\">[</span><span class=\"token number\">20</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">def</span> <span class=\"token function\">monitor</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span>     pr <span class=\"token operator\">=</span> cProfile<span class=\"token punctuation\">.</span>Profile<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span>     pr<span class=\"token punctuation\">.</span>enable<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span>     matches<span class=\"token punctuation\">,</span> scores <span class=\"token operator\">=</span> f<span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>args<span class=\"token punctuation\">)</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span>     pr<span class=\"token punctuation\">.</span>disable<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span>     pr<span class=\"token punctuation\">.</span>dump_stats<span class=\"token punctuation\">(</span><span class=\"token string\">\"program.prof\"</span><span class=\"token punctuation\">)</span> \n    \nIn <span class=\"token punctuation\">[</span><span class=\"token number\">21</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> monitor<span class=\"token punctuation\">(</span>match_change<span class=\"token punctuation\">,</span> patterns<span class=\"token punctuation\">)</span></code></pre></div>\n<p>The profiler saves the inspection results in <code class=\"language-text\">program.prof</code> this can be used by snakeviz to give helpful visualizations.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">snakeviz /path/to/program.prof</code></pre></div>\n<p>I see this plot on my machine:\n<figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 690px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/853c950bcdad7ebe1f45ef1c53f34998/a8a6f/pattern_experiment_icicle.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 28.323699421965316%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABJ0lEQVQY06WRO0/CUBiG+1P8Cc7+DAeBxFFB3dhwdHR3EylEFqOLDtbBkKiJyMViZDGoEYkhIVZaGui9fTxtcHHUN3nynZO8eXIukm3bhGHIf+K5LoZhYJomkiM2ENHXZmxVO2wcqmxWYzrkyk1Bg/XiDWv712TlO7KletLJzXurxRYX3aFwBNiOi6TrBr5j0RuZpCsqK7JKqjznoMHyXo1UsU5GbpGW26QEGdFb2r1iceeShYJC5fY9OWkQRkia9oUx1ngZGWwrz+SPVfInKoXzHqePI5T7PmfNV2pPGkcPQ0qtAeX2gO5wwsfY4u1zysTyEmEUCWEg3s8V13ZcD932GU+dBF2UXD/EEziujy+m7QXMxNoS83diWRzprx8RC8I5P7J4fgMCYa2tRivlnQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Fig. Icicle plot of program performance (click to zoom)\"\n        title=\"Fig. Icicle plot of program performance (click to zoom)\"\n        src=\"/blog/static/853c950bcdad7ebe1f45ef1c53f34998/1e043/pattern_experiment_icicle.png\"\n        srcset=\"/blog/static/853c950bcdad7ebe1f45ef1c53f34998/991de/pattern_experiment_icicle.png 173w,\n/blog/static/853c950bcdad7ebe1f45ef1c53f34998/e4d6b/pattern_experiment_icicle.png 345w,\n/blog/static/853c950bcdad7ebe1f45ef1c53f34998/1e043/pattern_experiment_icicle.png 690w,\n/blog/static/853c950bcdad7ebe1f45ef1c53f34998/e3189/pattern_experiment_icicle.png 1035w,\n/blog/static/853c950bcdad7ebe1f45ef1c53f34998/b1001/pattern_experiment_icicle.png 1380w,\n/blog/static/853c950bcdad7ebe1f45ef1c53f34998/a8a6f/pattern_experiment_icicle.png 1516w\"\n        sizes=\"(max-width: 690px) 100vw, 690px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Fig. Icicle plot of program performance (click to zoom)</figcaption>\n  </figure></p>\n<p>According to this we spend 201ms for <code class=\"language-text\">re.search</code> and 71ms for <code class=\"language-text\">re.compile</code>. Let's try to pre-compile our patterns and check the results.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">In <span class=\"token punctuation\">[</span><span class=\"token number\">30</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> compiled_patterns <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>re<span class=\"token punctuation\">.</span><span class=\"token builtin\">compile</span><span class=\"token punctuation\">(</span>pattern<span class=\"token punctuation\">,</span> flags<span class=\"token operator\">=</span>re<span class=\"token punctuation\">.</span>I<span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> pattern <span class=\"token keyword\">in</span> patterns<span class=\"token punctuation\">]</span> \n\nIn <span class=\"token punctuation\">[</span><span class=\"token number\">31</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">def</span> <span class=\"token function\">match_change</span><span class=\"token punctuation\">(</span>items<span class=\"token punctuation\">,</span> patterns<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span>     matches <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span>     scores <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span>     <span class=\"token keyword\">for</span> item <span class=\"token keyword\">in</span> items<span class=\"token punctuation\">:</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span>         <span class=\"token keyword\">for</span> pattern <span class=\"token keyword\">in</span> compiled_patterns<span class=\"token punctuation\">:</span> <span class=\"token comment\"># Swap the variable</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span>             sentence <span class=\"token operator\">=</span> item<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span>             match <span class=\"token operator\">=</span> pattern<span class=\"token punctuation\">.</span>search<span class=\"token punctuation\">(</span>sentence<span class=\"token punctuation\">)</span> <span class=\"token comment\"># Change the API</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span>             <span class=\"token keyword\">if</span> match<span class=\"token punctuation\">:</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span>                 matches<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span>                 scores<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>match<span class=\"token punctuation\">.</span>end<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> match<span class=\"token punctuation\">.</span>start<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span>     <span class=\"token keyword\">return</span> matches<span class=\"token punctuation\">,</span> scores </code></pre></div>\n<p>Line [30] has an additional <code class=\"language-text\">flags=re.I</code> thrown in, we would need it to do case insensitive searches. Let's see how much this change helps. It shouldn't do much because we only lost 70ms to it.\n<figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 690px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/c53a8ee6ff9be466960beaa7f0cedd7b/6bfbb/pattern_experiment_icicle_2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 22.54335260115607%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAABCUlEQVQY06WQ2UrDQBhG8yDe+BxeasEqPo4YxTeo6IXi8gRuWLxSKBhBFLTUImlS7wRrXeKSZiklMyY5Thb0AfzhcGb55mdmNCEESRITyZjOk/dHv3TPVXZ/beYe5HuWynRffOxnn08vJPB9NCEkkPIRChaPrIK6xVLdVmMTff8W/aDNwm6z8F4L/fCuzFgsH9vo6syDE5DGEi0IQhIZ8fg1ZGbrJmd2u8n0+iWVtXOFwWStwdRKg8qqQXXjiurmNXM7TSZqF4zrp4zNn9DueWSlOY7DwHUJRxG2M8R+C3Nbr4HCp6OeZPbdch4UGUVX0VJNjPt3zhTeSBYNsz/Mbvkti4X/VJqm/ACe8lzYeTpGuAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Fig. Icicle plot after pre-compiling patterns (click to zoom)\"\n        title=\"Fig. Icicle plot after pre-compiling patterns (click to zoom)\"\n        src=\"/blog/static/c53a8ee6ff9be466960beaa7f0cedd7b/1e043/pattern_experiment_icicle_2.png\"\n        srcset=\"/blog/static/c53a8ee6ff9be466960beaa7f0cedd7b/991de/pattern_experiment_icicle_2.png 173w,\n/blog/static/c53a8ee6ff9be466960beaa7f0cedd7b/e4d6b/pattern_experiment_icicle_2.png 345w,\n/blog/static/c53a8ee6ff9be466960beaa7f0cedd7b/1e043/pattern_experiment_icicle_2.png 690w,\n/blog/static/c53a8ee6ff9be466960beaa7f0cedd7b/e3189/pattern_experiment_icicle_2.png 1035w,\n/blog/static/c53a8ee6ff9be466960beaa7f0cedd7b/b1001/pattern_experiment_icicle_2.png 1380w,\n/blog/static/c53a8ee6ff9be466960beaa7f0cedd7b/6bfbb/pattern_experiment_icicle_2.png 1514w\"\n        sizes=\"(max-width: 690px) 100vw, 690px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Fig. Icicle plot after pre-compiling patterns (click to zoom)</figcaption>\n  </figure></p>\n<p>As expected this isn't a huge change, but let's not underestimate it as well. This is a change that scales. What if we had 100s of patterns? taking 4 patterns per-intent leads us to <code class=\"language-text\">4 x 150 = 600</code> Patterns.\nLet's simulate with 400 patterns and compare the results, both with and without pre-compilation. Let's simulate some patterns:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">patterns <span class=\"token operator\">=</span> patterns <span class=\"token operator\">*</span> <span class=\"token number\">20</span> <span class=\"token comment\"># We have 440 patterns now.</span></code></pre></div>\n<p>We recalculate compiled_patterns as well to keep it fair.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 690px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/254d0dddf85a709888cb413d889fc436/f2b95/pattern_experiment_icicle_3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 21.965317919075144%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAABFklEQVQY01WQPUsCAQCG78/0ExpbMiKC+gUO0eTUEDVEtbUoQSHUVC5hgxVBX2CJgx0kScoJaZlleH7hR3fpfeid+XQuYS888PIM7/AKlmXR7XZhMKBj2nw2NYot/Q/5y0AedsfLI76sGFRVk4pDq62jKgqKg2DbNppu4Cxyna7i2hGZ348ztxdn1i8y6b3F5bvD5Q0ztR1l2mFm954JX4zxrShj62H8kTzD9CwbwTRN6o0GPz2DyGsdd1BiMZhk4TiF5zTD2rnEaijB5lWWjZscyxcZVi6zLIXSeI6SuA8SnD2V/g+2Ox309jfPFZXAY4mA+MbhQ4ETqcZH3eCl2CRfVsnVNMRCk9h7g5beYzTOY/T7fX4BevwRuUgKd+UAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Fig. Icicle plot showing performance of program with 440 un-compiled patterns\"\n        title=\"Fig. Icicle plot showing performance of program with 440 un-compiled patterns\"\n        src=\"/blog/static/254d0dddf85a709888cb413d889fc436/1e043/pattern_experiment_icicle_3.png\"\n        srcset=\"/blog/static/254d0dddf85a709888cb413d889fc436/991de/pattern_experiment_icicle_3.png 173w,\n/blog/static/254d0dddf85a709888cb413d889fc436/e4d6b/pattern_experiment_icicle_3.png 345w,\n/blog/static/254d0dddf85a709888cb413d889fc436/1e043/pattern_experiment_icicle_3.png 690w,\n/blog/static/254d0dddf85a709888cb413d889fc436/e3189/pattern_experiment_icicle_3.png 1035w,\n/blog/static/254d0dddf85a709888cb413d889fc436/b1001/pattern_experiment_icicle_3.png 1380w,\n/blog/static/254d0dddf85a709888cb413d889fc436/f2b95/pattern_experiment_icicle_3.png 1515w\"\n        sizes=\"(max-width: 690px) 100vw, 690px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Fig. Icicle plot showing performance of program with 440 un-compiled patterns</figcaption>\n  </figure>\n<figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 690px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/3e7df11eaf9e77b2e9409ea2882fa119/a8a6f/pattern_experiment_4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 22.54335260115607%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA8UlEQVQY062Q3UoCYRCG9zY67kI6y8jqWrJVqJsQD/qhjvuXDoMOigwqMqXSdVU6tbDdSPu+RL9l3Z5m1+6gBh6Yl5l5ZxjLGEMURfw1zGiEUgrLBIHIbzq9IZnDGrlindyxUHTIHj1h71ewD6qs7N5JXsXei/UDWanHvasnDssy1+j0xGaMpbSGMKD9ppnbLLO4fc+CML9+Q6pQSpjNnyekCpekN25Jb5VZ2qkwk79meu2MKfuUq+f35FLL8zzUZx89NLjegOYvrixodFWC89rH7cZaT2pCyx/w+KIotX0uWj4fX2ZiGP9Qy5XjMOQ/4gdQlGF59a49xwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Fig. Icicle plot showing performance of program with 440 pre-compiled patterns\"\n        title=\"Fig. Icicle plot showing performance of program with 440 pre-compiled patterns\"\n        src=\"/blog/static/3e7df11eaf9e77b2e9409ea2882fa119/1e043/pattern_experiment_4.png\"\n        srcset=\"/blog/static/3e7df11eaf9e77b2e9409ea2882fa119/991de/pattern_experiment_4.png 173w,\n/blog/static/3e7df11eaf9e77b2e9409ea2882fa119/e4d6b/pattern_experiment_4.png 345w,\n/blog/static/3e7df11eaf9e77b2e9409ea2882fa119/1e043/pattern_experiment_4.png 690w,\n/blog/static/3e7df11eaf9e77b2e9409ea2882fa119/e3189/pattern_experiment_4.png 1035w,\n/blog/static/3e7df11eaf9e77b2e9409ea2882fa119/b1001/pattern_experiment_4.png 1380w,\n/blog/static/3e7df11eaf9e77b2e9409ea2882fa119/a8a6f/pattern_experiment_4.png 1516w\"\n        sizes=\"(max-width: 690px) 100vw, 690px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Fig. Icicle plot showing performance of program with 440 pre-compiled patterns</figcaption>\n  </figure></p>\n<p>A whopping <strong>1.36s</strong> saved! That said, both numbers are painfully sad to the point of being unusable or at least frustrating. This could mean around <strong>7s to 10s</strong> of total response from a smart-home device. That wouldn't be <em>very smart</em>.</p>\n<h2 id=\"slow-patterns\" style=\"position:relative;\"><a href=\"#slow-patterns\" aria-label=\"slow patterns permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Slow patterns</h2>\n<p>We did talk about our code being a sloppy <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(n^{2})</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.064108em;vertical-align:-0.25em;\"></span><span class=\"mord mathdefault\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathdefault\">n</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span> but there is more, a bigger culprit. If you use regular expressions a lot you probably noticed it a while back. Regular expression searches themselves are <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><mi>n</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(n)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathdefault\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord mathdefault\">n</span><span class=\"mclose\">)</span></span></span></span> to <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(n^{2})</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.064108em;vertical-align:-0.25em;\"></span><span class=\"mord mathdefault\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathdefault\">n</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141079999999999em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span> depending on the pattern and the engine. This might make them hard to fix, but there are hints. If your regular expression backtracks a lot, its going to hurt. Notice all the patterns we used had <code class=\"language-text\">.*</code> in them?</p>\n<p><code class=\"language-text\">.*</code> makes it convenient to express things like, <em>give me anything that has THIS and THAT, I don't care about what's in between</em>. This gives the regex engine a hard time, <code class=\"language-text\">.*</code> is greedy and that means it matches everything till it reaches <em>THAT</em>, but when it doesn't, it goes back a step to check if the things that it matched to <code class=\"language-text\">.*</code> happen to be <em>THAT</em>. The longer the sentences the slower this gets.</p>\n<p>Let's try that out. The same patterns without <code class=\"language-text\">.*</code> but <code class=\"language-text\">\\s</code> instead.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">In <span class=\"token punctuation\">[</span><span class=\"token number\">55</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> patterns <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">r\"change name\"</span><span class=\"token punctuation\">,</span>  \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span> <span class=\"token string\">r\"change oil\"</span><span class=\"token punctuation\">,</span>  \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span> <span class=\"token string\">r\"swap accent\"</span><span class=\"token punctuation\">,</span>  \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span> <span class=\"token string\">r\"need change\"</span><span class=\"token punctuation\">,</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span> <span class=\"token string\">r\"please change\"</span><span class=\"token punctuation\">,</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span> <span class=\"token string\">r\"i need to change\"</span><span class=\"token punctuation\">,</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span> <span class=\"token string\">r\"limit change\"</span><span class=\"token punctuation\">,</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span> <span class=\"token string\">r\"change pin\"</span><span class=\"token punctuation\">,</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span> <span class=\"token string\">r\"change tires?\"</span><span class=\"token punctuation\">,</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span> <span class=\"token string\">r\"change credit limit\"</span><span class=\"token punctuation\">,</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span> <span class=\"token string\">r\"language change\"</span><span class=\"token punctuation\">,</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span> <span class=\"token string\">r\"change language\"</span><span class=\"token punctuation\">,</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span> <span class=\"token string\">r\"pin change\"</span><span class=\"token punctuation\">,</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span> <span class=\"token string\">r\"speed change\"</span><span class=\"token punctuation\">,</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span> <span class=\"token string\">r\"change accent\"</span><span class=\"token punctuation\">,</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span> <span class=\"token string\">r\"credit change\"</span><span class=\"token punctuation\">,</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span> <span class=\"token string\">r\"insurance change\"</span><span class=\"token punctuation\">,</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span> <span class=\"token string\">r\"oil change\"</span><span class=\"token punctuation\">,</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span> <span class=\"token string\">r\"change speed\"</span><span class=\"token punctuation\">,</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span> <span class=\"token string\">r\"how change\"</span><span class=\"token punctuation\">,</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span> <span class=\"token string\">r\"when change\"</span><span class=\"token punctuation\">,</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span> <span class=\"token string\">r\"why change\"</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>Before we go ahead with these, let's see how our previous patterns fared in terms of results.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token punctuation\">{</span><span class=\"token string\">'insurance_change'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">13</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'change_language'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">13</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'change_user_name'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">18</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'oil_change_how'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">175</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'next_song'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'oil_change_when'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">210</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'reminder'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'change_speed'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'schedule_maintenance'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">41</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'todo_list'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'change_accent'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">27</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'tire_change'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">88</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'exchange_rate'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">14</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'pin_change'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">75</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'last_maintenance'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">47</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'measurement_conversion'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'taxes'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'cancel'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'reset_settings'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'credit_limit_change'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">16</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'change_ai_name'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">50</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>Don't worry about the numbers, we allowed the same sentence to match against different patterns so the count can cross the original class limits. It looks like these patterns while slow did a decent job, only a few matches are out of the expected classes, with minor frequency. We'll see how the modified pattern's fare in terms of speed and accuracy.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token punctuation\">{</span><span class=\"token string\">'insurance_change'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'change_language'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">9</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'change_user_name'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'oil_change_how'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">20</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'next_song'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'oil_change_when'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">64</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'reminder'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'change_speed'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'schedule_maintenance'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">25</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'todo_list'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'change_accent'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'tire_change'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'pin_change'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">9</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'last_maintenance'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">18</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'reset_settings'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'credit_limit_change'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span>\n <span class=\"token string\">'change_ai_name'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">6</span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>These patterns are sparingly selective about the sentences. We will simulated a large number of patterns to compare with the previous. Let's see how slower is that, for the sake of bervity we will assume plots from compiled patterns.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 690px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/70ed1062a5a002f7eaa2be86d8a65e0a/f2b95/pattern_experiment_icicle_5.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 32.947976878612714%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABOUlEQVQoz52RTUsCYRDH91N4arNTX6OvU1B6KPo2nSQFPRS9XUJNg0JMU2+ipOhh32h18XXV3V+zi6FQh2jgx8wz8/CfmedR3MUCfJ+huyCvmxQMK6QY+OAcoBmCLrHBk1AwTIq6RaVnU+4MaOkOk/EIx3FQ5q6LKNI2xxylqsQzdWKZmvgG8VSFWLJM7LLESeI1jI+TJWLpd7lT5zTd4DBR5eK5IxJLprMZytAe4jLl82XOY8Qgt2eSi5o8RHvc7n5wrba4Upvc7LS5V7tkVZ28KvV9jYOzApHzO2lUI7CVD4pt2wxGQzxrCVnJ5v9ATihAszPiTdbuWpNQ0JenU/r9PpZlsZSRPVl9tcYLYQv/R33bArHAFE3TmMnuYTKYeUVIEP/Opu55Ii54a7FwQjf8lE2Hb/9f+wL5ivyppovdUQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Fig. Icicle plot showing performance of patterns with .* removed\"\n        title=\"Fig. Icicle plot showing performance of patterns with .* removed\"\n        src=\"/blog/static/70ed1062a5a002f7eaa2be86d8a65e0a/1e043/pattern_experiment_icicle_5.png\"\n        srcset=\"/blog/static/70ed1062a5a002f7eaa2be86d8a65e0a/991de/pattern_experiment_icicle_5.png 173w,\n/blog/static/70ed1062a5a002f7eaa2be86d8a65e0a/e4d6b/pattern_experiment_icicle_5.png 345w,\n/blog/static/70ed1062a5a002f7eaa2be86d8a65e0a/1e043/pattern_experiment_icicle_5.png 690w,\n/blog/static/70ed1062a5a002f7eaa2be86d8a65e0a/e3189/pattern_experiment_icicle_5.png 1035w,\n/blog/static/70ed1062a5a002f7eaa2be86d8a65e0a/b1001/pattern_experiment_icicle_5.png 1380w,\n/blog/static/70ed1062a5a002f7eaa2be86d8a65e0a/f2b95/pattern_experiment_icicle_5.png 1515w\"\n        sizes=\"(max-width: 690px) 100vw, 690px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Fig. Icicle plot showing performance of patterns with .* removed</figcaption>\n  </figure></p>\n<p>That's not a lot of boost? A gain of 13ms is trivial when the overall time is over 3 seconds.</p>\n<blockquote>\n<p>TODO: Spend more time knowing why the gain is tiny.</p>\n</blockquote>\n<h2 id=\"compile-time-speed-boost\" style=\"position:relative;\"><a href=\"#compile-time-speed-boost\" aria-label=\"compile time speed boost permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Compile time speed boost</h2>\n<p>There is still something we can do about programs that are slow. We can port our logic to a compiled language. Since python is dynamically typed it has to make assumptions about the data, this could be slow when performing compute intensive logic. This is where languages like C, C++, Go, Rust shine. I'll be picking Rust because of its unicode support and <a href=\"https://github.com/PyO3/pyo3\">pyo3</a> making it very easy to write wrappers around Rust code and presence of <a href=\"https://github.com/PyO3/maturin\">maturin</a> that allows shipping these wrappers as <code class=\"language-text\">pip</code> packages! Also the <a href=\"https://docs.rs/regex/1.3.7/regex/\">regex</a> Implementation has features missing in python, like <a href=\"https://docs.rs/regex/1.3.7/regex/#example-avoid-compiling-the-same-regex-in-a-loop\">1</a>, <a href=\"https://docs.rs/regex/1.3.7/regex/#example-match-multiple-regular-expressions-simultaneously\">2</a> <a href=\"https://docs.rs/regex/1.3.7/regex/#syntax\">3</a> and <a href=\"https://docs.rs/regex/1.3.7/regex/#crate-features\">4</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token comment\">// - Wrapper for python</span>\n\n<span class=\"token keyword\">extern</span> <span class=\"token keyword\">crate</span> <span class=\"token module-declaration namespace\">regex</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">use</span> <span class=\"token namespace\">pyo3<span class=\"token punctuation\">::</span>prelude<span class=\"token punctuation\">::</span></span><span class=\"token operator\">*</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token namespace\">std<span class=\"token punctuation\">::</span>os<span class=\"token punctuation\">::</span>raw<span class=\"token punctuation\">::</span></span>c_double<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">use</span> <span class=\"token namespace\">regex<span class=\"token punctuation\">::</span></span><span class=\"token class-name\">Regex</span><span class=\"token punctuation\">;</span>\n\n\n<span class=\"token attribute attr-name\">#[pyclass]</span>\n<span class=\"token keyword\">struct</span> <span class=\"token type-definition class-name\">GroupRegexMatch</span> <span class=\"token punctuation\">{</span>\n  compiled_patterns<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Vec</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Regex</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n  intents<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Vec</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token operator\">></span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token attribute attr-name\">#[pymethods]</span>\n<span class=\"token keyword\">impl</span> <span class=\"token class-name\">GroupRegexMatch</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token attribute attr-name\">#[new]</span>\n  <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">new</span><span class=\"token punctuation\">(</span>patterns<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Vec</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">str</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token class-name\">PyResult</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">GroupRegexMatch</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> compiled_patterns<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Vec</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Regex</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> patterns<span class=\"token punctuation\">.</span><span class=\"token function\">into_iter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token closure-params\"><span class=\"token closure-punctuation punctuation\">|</span>pattern<span class=\"token closure-punctuation punctuation\">|</span></span> <span class=\"token class-name\">Regex</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span>pattern<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Ok</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">GroupRegexMatch</span> <span class=\"token punctuation\">{</span> compiled_patterns <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">search</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> texts<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Vec</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">str</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token class-name\">PyResult</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Vec</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">f64</span><span class=\"token operator\">>></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Ok</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>compiled_patterns<span class=\"token punctuation\">.</span><span class=\"token function\">iter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token closure-params\"><span class=\"token closure-punctuation punctuation\">|</span>pattern<span class=\"token closure-punctuation punctuation\">|</span></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> scores<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Vec</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">f64</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> texts<span class=\"token punctuation\">.</span><span class=\"token function\">iter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token closure-params\"><span class=\"token closure-punctuation punctuation\">|</span>text<span class=\"token closure-punctuation punctuation\">|</span></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">match</span> pattern<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span>text<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n              <span class=\"token class-name\">None</span> <span class=\"token operator\">=></span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">,</span>\n              <span class=\"token class-name\">Some</span><span class=\"token punctuation\">(</span>mat<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>mat<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> mat<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">as</span> c_double <span class=\"token operator\">/</span> text<span class=\"token punctuation\">.</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> c_double<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">let</span> non_zero_scores<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Vec</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">f64</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> scores<span class=\"token punctuation\">.</span><span class=\"token function\">iter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">cloned</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token closure-params\"><span class=\"token closure-punctuation punctuation\">|</span>score<span class=\"token closure-punctuation punctuation\">|</span></span> score <span class=\"token operator\">></span> <span class=\"token operator\">&amp;</span><span class=\"token number\">0.0</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">let</span> max_score<span class=\"token punctuation\">:</span> <span class=\"token keyword\">f64</span> <span class=\"token operator\">=</span> non_zero_scores<span class=\"token punctuation\">.</span><span class=\"token function\">iter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">cloned</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">.</span><span class=\"token function\">fold</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">.</span><span class=\"token operator\">/</span><span class=\"token number\">0</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">f64</span><span class=\"token punctuation\">::</span>max<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">let</span> score <span class=\"token operator\">=</span> <span class=\"token operator\">-</span><span class=\"token number\">1.0</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>non_zero_scores<span class=\"token punctuation\">.</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">f64</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> max_score<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> e_to_score <span class=\"token operator\">=</span> score<span class=\"token punctuation\">.</span><span class=\"token function\">exp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> score_sigmoid<span class=\"token punctuation\">:</span> <span class=\"token keyword\">f64</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">if</span> non_zero_scores<span class=\"token punctuation\">.</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token punctuation\">{</span> <span class=\"token number\">1</span><span class=\"token punctuation\">.</span> <span class=\"token operator\">/</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">.</span> <span class=\"token operator\">+</span> e_to_score<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span> <span class=\"token number\">0</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        score_sigmoid\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n\n<span class=\"token attribute attr-name\">#[pymodule]</span>\n<span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">exegr</span><span class=\"token punctuation\">(</span>_py<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Python</span><span class=\"token punctuation\">,</span> m<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token class-name\">PyModule</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token class-name\">PyResult</span><span class=\"token operator\">&lt;</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n  m<span class=\"token punctuation\">.</span><span class=\"token function\">add_class</span><span class=\"token punctuation\">::</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">GroupRegexMatch</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">Ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>You can access the config from the original repository <a href=\"https://github.com/ltbringer/exegr\">here</a></p>\n<p>(A lot of code above won't be explained in this post as it is not the goal of this post to explain Rust programming or creating python bindings from Rust.\nThe code is shared for the purposes of reproducing results.)</p>\n<p>We have a Rust <code class=\"language-text\">struct</code> which is instantiated with patterns. It exposes a search method on the instance which accepts a list of sentences\nand scores them with their span, vs length of the sentence. We need to build the binaries by running:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">cargo build --release</code></pre></div>\n<p>This step produces <code class=\"language-text\">libexegr.so</code> because I named the package <code class=\"language-text\">exegr</code>, we can copy it as <code class=\"language-text\">exegr.so</code> into the directory we are running python code for testing and development. Once that is done,\nwe can use it like any ordinary python library.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> exegr <span class=\"token keyword\">import</span> GroupRegexMatch</code></pre></div>\n<p>We will also modify our function <code class=\"language-text\">match_regex</code> to use this new library.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># - </span>\nIn <span class=\"token punctuation\">[</span><span class=\"token number\">34</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> g <span class=\"token operator\">=</span> GroupRegexMatch<span class=\"token punctuation\">(</span>patterns<span class=\"token punctuation\">)</span>\n\nIn <span class=\"token punctuation\">[</span><span class=\"token number\">35</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span> <span class=\"token keyword\">def</span> <span class=\"token function\">match_rustic</span><span class=\"token punctuation\">(</span>items<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span>     matches <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span>     scores <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span>     <span class=\"token keyword\">for</span> item <span class=\"token keyword\">in</span> items<span class=\"token punctuation\">:</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span>         score <span class=\"token operator\">=</span> <span class=\"token builtin\">sum</span><span class=\"token punctuation\">(</span>g<span class=\"token punctuation\">.</span>search<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>item<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span>         <span class=\"token keyword\">if</span> score <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span>             matches<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">)</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span>             scores<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>score<span class=\"token punctuation\">)</span> \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">:</span>     <span class=\"token keyword\">return</span> matches<span class=\"token punctuation\">,</span> scores </code></pre></div>\n<p>We pass each sentence one at a time and the library returns a list with scores for each pattern. If we see a non-zero score, we pick it (as we have been doing). We could pass multiple sentences but we aren't as we want them to be scored separately. This feature of accepting multiple sentences is for ASR outputs which generally produce multiple utterances that need to be used. Let's see how this works.</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 690px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/e20f09949e8485537200f1e3536e85e5/6bfbb/pattern_experiment_icicle_6.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 21.38728323699422%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA8ElEQVQY052Py0rDUBRF80tOnDpUrAX9Az/DuRYERXygOPELFDRQpYgWCRFBBR9oKSjWNqgt3qZ5mNyY22R5Wxw5dMHmbM6BBcdI05QkSSDP+UoUTRHhdGMc90+6v3s9WzrvnqTjS956EuFH+J5HEAQYSimiOAYyKo9txtdsZrYuKG7YTK1bFFZOmVw+ZmKxrPsJxdUzpjfPGVuyGC1VGZmvsm01GJD2MwwpJZ9C8C0jXkSI+fDBYa2Nee9wcNtk7/qZ3csn9m9eMe9alPWtUu+wcFRndueKObOG3egNhZn+cigMwxDXdcn6iv+Sa9mAH5zgHPOBK2AFAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Fig. Icicle plot of program ported to Rust and used via python bindings\"\n        title=\"Fig. Icicle plot of program ported to Rust and used via python bindings\"\n        src=\"/blog/static/e20f09949e8485537200f1e3536e85e5/1e043/pattern_experiment_icicle_6.png\"\n        srcset=\"/blog/static/e20f09949e8485537200f1e3536e85e5/991de/pattern_experiment_icicle_6.png 173w,\n/blog/static/e20f09949e8485537200f1e3536e85e5/e4d6b/pattern_experiment_icicle_6.png 345w,\n/blog/static/e20f09949e8485537200f1e3536e85e5/1e043/pattern_experiment_icicle_6.png 690w,\n/blog/static/e20f09949e8485537200f1e3536e85e5/e3189/pattern_experiment_icicle_6.png 1035w,\n/blog/static/e20f09949e8485537200f1e3536e85e5/b1001/pattern_experiment_icicle_6.png 1380w,\n/blog/static/e20f09949e8485537200f1e3536e85e5/6bfbb/pattern_experiment_icicle_6.png 1514w\"\n        sizes=\"(max-width: 690px) 100vw, 690px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Fig. Icicle plot of program ported to Rust and used via python bindings</figcaption>\n  </figure></p>\n<p>Yes, I ran this with all 440 patterns and we get down to <strong>38ms</strong>. This is much lesser than python's implementation using 21 patterns to yield results in <strong>200ms</strong>.</p>\n<p><em>fin.</em></p>","timeToRead":12,"excerpt":"To start our study, we will use this dataset from this repository.\nAn introductory analysis shows: Now, let's look at the training data a…","frontmatter":{"title":"Regular expressions and efficiency","cover":"https://unsplash.it/1152/300/?random?BirchintheRoses","date":"2020-04-25T00:00:00.000Z","categories":["programming","experiments"],"tags":["rust","python","optimization","machine learning"]},"fields":{"slug":"/regular-expressions-and-efficiency","date":"April 24, 2020"}}},"pageContext":{"slug":"/regular-expressions-and-efficiency","nexttitle":"The Resting potential","nextslug":"/the-resting-potential","prevtitle":"Text classification conflicts and hierarchical models","prevslug":"/text-classification-conflicts-and-hierarchical-models"}},"staticQueryHashes":["3969716136"]}